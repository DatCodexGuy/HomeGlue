{% extends "ui/base.html" %}
{% block title %}Admin | System Settings{% endblock %}
{% block content %}
  <section class="panel reveal">
    {% include "ui/_crumbs_simple.html" with crumbs=crumbs %}
    <div class="listhead">
      <div>
        <h1 class="h2">System Settings</h1>
        <div class="sub">Superuser-only settings for the whole HomeGlue instance.</div>
      </div>
      <div class="listhead__actions">
        <a class="btn btn--ghost btn--sm" href="{% url 'ui:super_admin_home' %}">
          <svg class="ico" viewBox="0 0 24 24"><use href="#i-back"/></svg>
          Back
        </a>
      </div>
    </div>

    {% if saved %}
      <div class="warn mt-12">
        <div class="warn__title">Saved</div>
        <div class="warn__body">System settings updated.</div>
      </div>
    {% endif %}

    {% if error %}
      <div class="warn mt-12">
        <div class="warn__title">Not saved</div>
        <div class="warn__body">{{ error }}</div>
      </div>
    {% endif %}

    <div class="split mt-14">
      <div class="split__main">
        <h3 class="h3">Base URL</h3>
        <div class="mini">
          <div class="muted">Used for absolute links in notifications (email/webhooks) and share links.</div>
          <form method="post" class="mt-10">
            {% csrf_token %}
            <input type="hidden" name="_action" value="save" />
            <label class="field">
              <div class="field__label">HOMEGLUE_BASE_URL override (optional)</div>
              <input class="input" type="text" name="base_url" value="{{ obj.base_url }}" placeholder="https://homeglue.example.com" />
            </label>
            <div class="mt-10">
              <button class="btn" type="submit">
                <svg class="ico" viewBox="0 0 24 24"><use href="#i-save"/></svg>
                Save
              </button>
            </div>
          </form>
        </div>

        <h3 class="h3 mt-16">IP Access Control</h3>
        <div class="mini">
          <div class="muted">Optional allow/block lists for the entire app (UI + API).</div>
          <form method="post" class="mt-10">
            {% csrf_token %}
            <input type="hidden" name="_action" value="save" />
            <label class="field">
              <div class="field__label">Allowlist (comma-separated CIDRs/IPs)</div>
              <textarea class="input" name="ip_allowlist" rows="2" placeholder="10.0.0.0/24,192.168.1.10">{{ obj.ip_allowlist }}</textarea>
            </label>
            <label class="field mt-10">
              <div class="field__label">Blocklist (comma-separated CIDRs/IPs)</div>
              <textarea class="input" name="ip_blocklist" rows="2" placeholder="10.0.0.123/32">{{ obj.ip_blocklist }}</textarea>
            </label>
            <label class="field mt-10 flex gap-10 items-center">
              <input type="checkbox" name="trust_x_forwarded_for" value="1" {% if obj.trust_x_forwarded_for %}checked{% endif %} />
              <div class="muted">Trust `X-Forwarded-For` (only when REMOTE_ADDR is a trusted proxy)</div>
            </label>
            <label class="field mt-10">
              <div class="field__label">Trusted proxy CIDRs (comma-separated)</div>
              <textarea class="input" name="trusted_proxy_cidrs" rows="2" placeholder="10.0.0.0/24">{{ obj.trusted_proxy_cidrs }}</textarea>
            </label>
            <div class="mt-10">
              <button class="btn" type="submit">
                <svg class="ico" viewBox="0 0 24 24"><use href="#i-save"/></svg>
                Save
              </button>
            </div>
          </form>
        </div>

        <h3 class="h3 mt-16">Browser / Reverse Proxy Origins</h3>
        <div class="mini">
          <div class="muted">
            These are used when HomeGlue is accessed behind a reverse proxy or from a different origin.
            Changes apply immediately (no container restart).
          </div>
          <form method="post" class="mt-10">
            {% csrf_token %}
            <input type="hidden" name="_action" value="save" />
            <label class="field">
              <div class="field__label">CORS Allowed Origins (comma-separated)</div>
              <textarea class="input" name="cors_allowed_origins" rows="2" placeholder="https://homeglue.example.com">{{ obj.cors_allowed_origins }}</textarea>
              <div class="muted">Only needed for cross-origin browser/API clients.</div>
            </label>
            <label class="field mt-10">
              <div class="field__label">CSRF Trusted Origins (comma-separated)</div>
              <textarea class="input" name="csrf_trusted_origins" rows="2" placeholder="https://homeglue.example.com">{{ obj.csrf_trusted_origins }}</textarea>
              <div class="muted">If you see CSRF errors behind a proxy, add your public URL here.</div>
            </label>
            <div class="mt-10">
              <button class="btn" type="submit">
                <svg class="ico" viewBox="0 0 24 24"><use href="#i-save"/></svg>
                Save
              </button>
            </div>
          </form>
        </div>

        <h3 class="h3 mt-16">Hosts &amp; Timeouts</h3>
        <div class="mini">
          <div class="muted">
            These settings affect host validation and operational behavior. Changes apply immediately.
            If you set ALLOWED_HOSTS incorrectly, you may lock yourself out.
          </div>
          <form method="post" class="mt-10">
            {% csrf_token %}
            <input type="hidden" name="_action" value="save" />
            <label class="field">
              <div class="field__label">ALLOWED_HOSTS override (comma-separated)</div>
              <textarea class="input" name="allowed_hosts" rows="2" placeholder="homeglue.example.com,10.0.0.10">{{ obj.allowed_hosts }}</textarea>
              <div class="muted">Leave empty to use env-backed `HOMEGLUE_ALLOWED_HOSTS`.</div>
            </label>

            <div class="grid2 mt-10">
              <label class="field">
                <div class="field__label">Re-auth TTL (seconds)</div>
                <input class="input" type="number" name="reauth_ttl_seconds" min="60" max="86400" value="{{ obj.reauth_ttl_seconds }}" />
                <div class="muted">Sensitive actions (reveal password, OTP codes).</div>
              </label>
              <label class="field">
                <div class="field__label">Webhook timeout (seconds)</div>
                <input class="input" type="number" name="webhook_timeout_seconds" min="1" max="120" value="{{ obj.webhook_timeout_seconds }}" />
                <div class="muted">Outbound webhook delivery.</div>
              </label>
            </div>

            <label class="field mt-10">
              <div class="field__label">SMTP timeout (seconds)</div>
              <input class="input" type="number" name="smtp_timeout_seconds" min="1" max="120" value="{{ obj.smtp_timeout_seconds }}" />
              <div class="muted">Email delivery timeout for SMTP backend.</div>
            </label>

            <div class="mt-10">
              <button class="btn" type="submit">
                <svg class="ico" viewBox="0 0 24 24"><use href="#i-save"/></svg>
                Save
              </button>
            </div>
          </form>
        </div>
      </div>

      <div class="split__side">
        <h3 class="h3">Notes</h3>
        <div class="mini">
          <div class="muted">
            These DB-backed settings override env vars when set.
            If you prefer immutable config, keep these empty and configure via `.env`.
          </div>
          <div class="muted mt-10">
            Docs: <a class="link" href="{% url 'ui:wiki_page' slug='security' %}">Security</a>
          </div>
        </div>
      </div>
    </div>
  </section>
{% endblock %}
