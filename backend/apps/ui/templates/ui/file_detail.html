{% extends "ui/base.html" %}
{% block title %}{{ filename }} | Files | {{ org.name }}{% endblock %}
{% block content %}
  <section class="panel reveal">
    {% include "ui/_crumbs_simple.html" with crumbs=crumbs %}

    <div class="listhead">
      <div>
        <h1 class="h2 mono">{{ filename }}</h1>
        <div class="sub">
          Uploaded {{ a.created_at|date:"Y-m-d H:i" }}
          {% if a.uploaded_by %}<span class="dot"></span>by <span class="mono">{{ a.uploaded_by.username }}</span>{% endif %}
          {% if size %}<span class="dot"></span><span class="mono">{{ size }} bytes</span>{% endif %}
        </div>
      </div>
      <div class="listhead__actions">
        <a class="btn btn--ghost btn--sm" href="{% url 'ui:files_list' %}">
          <svg class="ico" viewBox="0 0 24 24"><use href="#i-back"/></svg>
          Back
        </a>
        <a class="btn btn--ghost btn--sm" href="{{ download_url }}">
          <svg class="ico" viewBox="0 0 24 24"><use href="#i-download"/></svg>
          Download
        </a>
        <a class="btn btn--danger btn--sm" href="{% url 'ui:attachment_delete' attachment_id=a.id %}">
          <svg class="ico" viewBox="0 0 24 24"><use href="#i-trash"/></svg>
          Delete
        </a>
      </div>
    </div>

    <div class="mini">
      <div class="mini__row">
        <div class="muted">Attached to</div>
        <div>
          {% if attached_url %}
            <a class="link mono" href="{{ attached_url }}">{{ attached_label }}</a>
          {% else %}
            <span class="mono">{{ attached_label|default:"(org)" }}</span>
          {% endif %}
        </div>
      </div>
      <div class="mini__row">
        <div class="muted">Content type</div>
        <div class="mono">{{ content_type }}</div>
      </div>
    </div>

    <div style="margin-top:18px">
      <h3 class="h3">Filing</h3>
      <form method="post" class="form" style="max-width:860px">
        {% csrf_token %}
        <input type="hidden" name="_action" value="save_meta" />
        <div class="grid" style="grid-template-columns: 1fr 1.2fr; gap:12px">
          <div>
            <label for="id_folder">Folder</label>
            <select id="id_folder" name="folder_id">
              <option value="">(none)</option>
              {% for f in folders %}
                <option value="{{ f.id }}" {% if a.folder_id == f.id %}selected{% endif %}>
                  {{ f.name }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="id_tags">Tags</label>
            <select id="id_tags" name="tag_ids" multiple size="5">
              {% for t in tags %}
                <option value="{{ t.id }}" {% if t in a.tags.all %}selected{% endif %}>
                  {{ t.name }}{% if t.organization_id %} (org){% else %} (global){% endif %}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:10px">
          <button class="btn btn--sm" type="submit">
            <svg class="ico" viewBox="0 0 24 24"><use href="#i-save"/></svg>
            Save
          </button>
          <div class="muted sub">Folder and tag organization does not change access control.</div>
        </div>
      </form>
    </div>

    {% if can_admin %}
      <div style="margin-top:18px">
        <h3 class="h3">SafeShare</h3>
        <div class="warn">
          <div class="warn__title">Public link</div>
          <div class="warn__body">Anyone with this link can download the file until it expires (or is revoked).</div>
        </div>

        {% if share_new_url %}
          <div class="secretbox" style="margin-top:10px">
            <div class="secretbox__label">New share link (copy now)</div>
            <div class="secretbox__value mono" data-copy style="word-break:break-all">{{ share_new_url }}</div>
            <div class="muted">This is only shown once.</div>
          </div>
        {% endif %}

        {% if not is_reauthed %}
          <div class="mini" style="margin-top:10px">
            <div class="muted">Re-authentication required before creating or revoking share links.</div>
            <a class="btn btn--ghost btn--sm" href="{{ reauth_url }}" style="margin-top:8px">
              <svg class="ico" viewBox="0 0 24 24"><use href="#i-shield"/></svg>
              Re-authenticate
            </a>
          </div>
        {% endif %}

        <form method="post" class="form" style="margin-top:10px; max-width:860px">
          {% csrf_token %}
          <input type="hidden" name="_action" value="share_create" />
          <p>
            <label for="id_share_label">Label (optional)</label>
            <input id="id_share_label" type="text" name="label" placeholder="e.g. Vendor transfer" />
          </p>
          <div class="grid" style="grid-template-columns: 1fr 1fr; gap:10px">
            <div>
              <label for="id_share_expires">Expires</label>
              <select id="id_share_expires" name="expires_in_hours">
                <option value="1">1 hour</option>
                <option value="24" selected>24 hours</option>
                <option value="168">7 days</option>
                <option value="720">30 days</option>
              </select>
            </div>
            <div>
              <label for="id_share_one_time">One-time</label>
              <select id="id_share_one_time" name="one_time">
                <option value="0" selected>No</option>
                <option value="1">Yes (download once)</option>
              </select>
            </div>
          </div>
          <div class="grid" style="grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px">
            <div>
              <label for="id_share_passphrase">Passphrase (optional)</label>
              <input id="id_share_passphrase" type="password" name="passphrase" autocomplete="new-password" placeholder="Require passphrase to download" />
            </div>
            <div>
              <label for="id_share_max_downloads">Max downloads (optional)</label>
              <input id="id_share_max_downloads" type="number" min="1" step="1" name="max_downloads" placeholder="Unlimited if empty" />
            </div>
          </div>
          <button class="btn btn--ghost btn--sm" type="submit" style="margin-top:10px">
            <svg class="ico" viewBox="0 0 24 24"><use href="#i-link"/></svg>
            Create share link
          </button>
        </form>

        {% if share_links %}
          <div style="display:flex; justify-content:flex-end; margin-top:10px">
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="_action" value="share_revoke_all" />
              <button class="btn btn--danger btn--sm" type="submit">
                <svg class="ico" viewBox="0 0 24 24"><use href="#i-shield"/></svg>
                Revoke all active
              </button>
            </form>
          </div>
          <div class="table" style="margin-top:12px">
            <div class="row row--head" style="grid-template-columns: 1.1fr 0.7fr 0.7fr 0.8fr 0.7fr">
              <div>Link</div><div>Expires</div><div>Status</div><div>Last used</div><div></div>
            </div>
            {% for s in share_links %}
              <div class="row" style="grid-template-columns: 1.1fr 0.7fr 0.7fr 0.8fr 0.7fr">
                <div class="mono">
                  {{ s.label|default:"(no label)" }}
                  <div class="sub">
                    token {{ s.token_prefix }}â€¦
                    {% if s.one_time %}<span class="dot"></span>one-time{% endif %}
                    {% if s.max_downloads %}<span class="dot"></span>max {{ s.max_downloads }}{% endif %}
                    {% if s.passphrase_hash %}<span class="dot"></span>passphrase{% endif %}
                  </div>
                </div>
                <div class="muted mono">{{ s.expires_at|date:"Y-m-d H:i" }}</div>
                <div class="muted mono">
                  {% if s.revoked_at %}revoked{% elif s.expires_at and s.expires_at < now %}expired{% elif s.one_time and s.consumed_at %}consumed{% elif s.max_downloads and s.view_count >= s.max_downloads %}consumed{% else %}active{% endif %}
                  <div class="sub">downloads {{ s.view_count }}</div>
                </div>
                <div class="muted mono">
                  {% if s.last_viewed_at %}{{ s.last_viewed_at|date:"Y-m-d H:i" }}{% else %}...{% endif %}
                </div>
                <div style="display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap">
                  {% if s.is_active %}
                    <form method="post">
                      {% csrf_token %}
                      <input type="hidden" name="_action" value="share_revoke" />
                      <input type="hidden" name="share_id" value="{{ s.id }}" />
                      <button class="btn btn--danger btn--sm" type="submit">
                        <svg class="ico" viewBox="0 0 24 24"><use href="#i-trash"/></svg>
                        Revoke
                      </button>
                    </form>
                  {% else %}
                    <form method="post">
                      {% csrf_token %}
                      <input type="hidden" name="_action" value="share_delete" />
                      <input type="hidden" name="share_id" value="{{ s.id }}" />
                      <button class="btn btn--ghost btn--sm" type="submit">
                        <svg class="ico" viewBox="0 0 24 24"><use href="#i-trash"/></svg>
                        Delete
                      </button>
                    </form>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="muted" style="margin-top:10px">No share links yet.</div>
        {% endif %}
      </div>
    {% endif %}

    <div style="margin-top:18px">
      <h3 class="h3">Versions</h3>

      {% if can_admin %}
        <div class="mini" style="margin-bottom:12px">
          <div class="mini__row">
            <div class="mini__top">
              <span class="pill pill--tiny">Upload</span>
              <span class="muted">Create a new version</span>
            </div>
            <div class="mini__body">
              {% if is_reauthed %}
                <form method="post" enctype="multipart/form-data" class="form" style="max-width:860px">
                  {% csrf_token %}
                  <input type="hidden" name="_action" value="upload_version" />
                  <div class="grid" style="grid-template-columns:1.4fr 1fr; gap:12px">
                    <div>
                      <label for="id_new_version">New file</label>
                      <input id="id_new_version" type="file" name="file" required />
                    </div>
                    <div class="sub" style="align-self:end">
                      This will keep the current file as a historic version.
                    </div>
                  </div>
                  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:10px">
                    <button class="btn btn--sm" type="submit">
                      <svg class="ico" viewBox="0 0 24 24"><use href="#i-plus"/></svg>
                      Upload new version
                    </button>
                  </div>
                </form>
              {% else %}
                <a class="btn btn--sm" href="{{ reauth_url }}">
                  <svg class="ico" viewBox="0 0 24 24"><use href="#i-shield"/></svg>
                  Re-auth to upload versions
                </a>
              {% endif %}
            </div>
          </div>
        </div>
      {% endif %}

      <div class="table">
        <div class="row row--head" style="grid-template-columns:1.6fr 1fr 1fr 0.9fr">
          <div>Filename</div><div>Created</div><div>By</div><div></div>
        </div>
        {% for v in versions %}
          <div class="row" style="grid-template-columns:1.6fr 1fr 1fr 0.9fr">
            <div class="mono">
              {{ v.filename|default:"(file)" }}
              {% if v.bytes %}<div class="muted mono" style="margin-top:6px">{{ v.bytes }} bytes</div>{% endif %}
            </div>
            <div class="muted mono">{{ v.created_at|date:"Y-m-d H:i" }}</div>
            <div class="muted mono">{% if v.uploaded_by %}{{ v.uploaded_by.username }}{% else %}...{% endif %}</div>
            <div style="display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap">
              <a class="btn btn--ghost btn--sm" href="{% url 'ui:file_version_download' attachment_id=a.id version_id=v.id %}">
                <svg class="ico" viewBox="0 0 24 24"><use href="#i-download"/></svg>
                Download
              </a>
              {% if can_admin %}
                <form method="post" action="{% url 'ui:file_version_restore' attachment_id=a.id version_id=v.id %}">
                  {% csrf_token %}
                  <button class="btn btn--ghost btn--sm" type="submit" {% if not is_reauthed %}disabled{% endif %}>
                    <svg class="ico" viewBox="0 0 24 24"><use href="#i-save"/></svg>
                    Restore
                  </button>
                </form>
                <a class="btn btn--danger btn--sm" href="{% url 'ui:file_version_delete' attachment_id=a.id version_id=v.id %}">
                  <svg class="ico" viewBox="0 0 24 24"><use href="#i-trash"/></svg>
                  Delete
                </a>
              {% endif %}
            </div>
          </div>
        {% empty %}
          <div class="empty">
            <div class="empty__title">No versions yet</div>
            <div class="empty__body">Uploading a new version will keep the previous file here.</div>
          </div>
        {% endfor %}
      </div>

      {% if can_admin and not is_reauthed and versions %}
        <div class="sub" style="margin-top:10px">
          Restore is disabled until you <a class="link" href="{{ reauth_url }}">re-auth</a>.
        </div>
      {% endif %}
    </div>

    <div style="margin-top:18px">
      <h3 class="h3">Preview</h3>
      {% if preview_kind == "image" %}
        <div class="mini">
          <div class="mini__row">
            <img src="{{ inline_url }}" alt="{{ filename }}" style="max-width:100%; height:auto; border-radius:16px; border:1px solid var(--line)" />
          </div>
        </div>
      {% elif preview_kind == "pdf" %}
        <div class="mini">
          <div class="mini__row">
            <iframe src="{{ inline_url }}" title="{{ filename }}" style="width:100%; height:70vh; border:1px solid var(--line); border-radius:16px; background: var(--paper)"></iframe>
          </div>
        </div>
      {% elif preview_kind == "text" %}
        <div class="mini">
          <div class="mini__row">
            <pre class="mono" style="white-space:pre-wrap; margin:0">{% if preview_text %}{{ preview_text }}{% else %}(preview unavailable){% endif %}</pre>
          </div>
        </div>
      {% else %}
        <div class="muted">No preview available for this file type.</div>
      {% endif %}
    </div>

    <div style="margin-top:18px">
      <h3 class="h3">Activity</h3>
      {% include "ui/_activity.html" with activity=activity %}
    </div>
  </section>
{% endblock %}
