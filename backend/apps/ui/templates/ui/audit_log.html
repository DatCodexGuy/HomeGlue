{% extends "ui/base.html" %}
{% block title %}Audit Log | {{ org.name }}{% endblock %}
{% block content %}
  <section class="panel reveal">
    {% include "ui/_crumbs_simple.html" with crumbs=crumbs %}
    <div class="listhead">
      <div>
        <h1 class="h2">Audit Log</h1>
        <div class="sub">Central event trail for {{ org.name }}.</div>
      </div>
      <div class="listhead__actions">
        <a class="btn btn--ghost btn--sm" href="{{ export_url }}">
          <svg class="ico" viewBox="0 0 24 24"><use href="#i-download"/></svg>
          Export CSV
        </a>
      </div>
    </div>

    <div class="mini mb-12">
      <div class="mini__row">
        <div class="mini__top">
          <span class="pill pill--tiny">Governance</span>
          <span class="muted">Retention and purge controls</span>
        </div>
        <div class="mini__body">
          {% if not is_reauthed %}
            <div class="muted mb-8">Re-authentication required for policy changes and purge.</div>
            <a class="btn btn--ghost btn--sm" href="{{ reauth_url }}">
              <svg class="ico" viewBox="0 0 24 24"><use href="#i-shield"/></svg>
              Re-authenticate
            </a>
          {% endif %}
          <form method="post" class="form mt-10">
            {% csrf_token %}
            <input type="hidden" name="_action" value="policy_save" />
            <div class="grid grid--backup-policy">
              <div>
                <label for="id_enabled">Retention enabled</label>
                <select id="id_enabled" name="enabled">
                  <option value="1" {% if policy.enabled %}selected{% endif %}>Yes</option>
                  <option value="0" {% if not policy.enabled %}selected{% endif %}>No</option>
                </select>
              </div>
              <div>
                <label for="id_retention">Retention days</label>
                <input id="id_retention" type="number" min="7" max="3650" name="retention_days" value="{{ policy.retention_days }}" />
              </div>
              <div class="flex items-end gap-8">
                <button class="btn btn--ghost btn--sm" type="submit" {% if not is_reauthed %}disabled{% endif %}>
                  <svg class="ico" viewBox="0 0 24 24"><use href="#i-save"/></svg>
                  Save policy
                </button>
              </div>
            </div>
          </form>
          <form method="post" class="mt-8">
            {% csrf_token %}
            <input type="hidden" name="_action" value="purge_now" />
            <button class="btn btn--danger btn--sm" type="submit" {% if not is_reauthed %}disabled{% endif %}>
              <svg class="ico" viewBox="0 0 24 24"><use href="#i-trash"/></svg>
              Purge now (by retention policy)
            </button>
          </form>
        </div>
      </div>
    </div>

    <div class="table mb-12">
      <div class="row row--head row--audit-stats">
        <div>Total (24h)</div><div>Create</div><div>Update</div><div>Delete</div><div>System</div>
      </div>
      <div class="row row--audit-stats">
        <div class="mono">{{ stats_24h.total }}</div>
        <div class="mono">{{ stats_24h.create }}</div>
        <div class="mono">{{ stats_24h.update }}</div>
        <div class="mono">{{ stats_24h.delete }}</div>
        <div class="mono">{{ stats_24h.system }}</div>
      </div>
    </div>

    {% if top_models %}
      <div class="mini mb-12">
        <div class="mini__row">
          <div class="mini__top">
            <span class="pill pill--tiny">Top Models (24h)</span>
          </div>
          <div class="mini__body">
            {% for m in top_models %}
              <span class="pill pill--tiny">{{ m.model }}: {{ m.c }}</span>
            {% endfor %}
          </div>
        </div>
      </div>
    {% endif %}

    <form class="search mb-10" method="get">
      <input class="search__input" type="text" name="q" value="{{ q }}" placeholder="Search summary/model/user/ip..." />
      <select class="bulkbar__select" name="action" aria-label="Action">
        <option value="">All actions</option>
        <option value="create" {% if action == "create" %}selected{% endif %}>Create</option>
        <option value="update" {% if action == "update" %}selected{% endif %}>Update</option>
        <option value="delete" {% if action == "delete" %}selected{% endif %}>Delete</option>
      </select>
      <select class="bulkbar__select wmax-300" name="model" aria-label="Model">
        <option value="">All models</option>
        {% for m in model_choices %}
          <option value="{{ m.value }}" {% if model == m.value %}selected{% endif %}>{{ m.label }}</option>
        {% endfor %}
      </select>
      <select class="bulkbar__select" name="user" aria-label="Actor">
        <option value="" {% if not user_filter %}selected{% endif %}>Any actor</option>
        <option value="human" {% if user_filter == "human" %}selected{% endif %}>Human</option>
        <option value="system" {% if user_filter == "system" %}selected{% endif %}>System</option>
      </select>
      <input class="bulkbar__select" type="date" name="date_from" value="{{ date_from }}" />
      <input class="bulkbar__select" type="date" name="date_to" value="{{ date_to }}" />
      <input class="bulkbar__select wmax-120" type="number" min="1" max="5000" name="limit" value="{{ limit }}" />
      <button class="btn btn--ghost btn--sm" type="submit">
        <svg class="ico" viewBox="0 0 24 24"><use href="#i-search"/></svg>
        Filter
      </button>
      <a class="btn btn--ghost btn--sm" href="{% url 'ui:audit_log' %}">Clear</a>
    </form>

    <div class="table">
      <div class="row row--head row--audit">
        <div>When</div><div>Action</div><div>Target</div><div>PK</div><div>Actor</div><div>IP</div><div>Summary</div>
      </div>
      {% for e in items %}
        <div class="row row--audit">
          <div class="mono muted">{{ e.ts|date:"Y-m-d H:i:s" }}</div>
          <div>
            <span class="pill pill--tiny" title="{{ e.action_badge }}">{{ e.action_label }}</span>
          </div>
          <div class="mono" title="{{ e.model_raw }}">{{ e.model_label }}</div>
          <div class="mono">{{ e.object_pk }}</div>
          <div class="mono">{{ e.actor_label }}</div>
          <div class="mono muted">{{ e.ip|default:"..." }}</div>
          <div class="muted">{{ e.summary|default:"..." }}</div>
        </div>
      {% empty %}
        <div class="empty">
          <div class="empty__title">No events found</div>
          <div class="empty__body">Try broader filters or a larger limit.</div>
        </div>
      {% endfor %}
    </div>
  </section>
{% endblock %}
